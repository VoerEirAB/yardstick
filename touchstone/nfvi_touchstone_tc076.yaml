---

schema: "yardstick:task:0.1"
{% set FIXED_NET_ID = FIXED_NET_ID or false %}
{% set FIXED_SUBNET_ID = FIXED_SUBNET_ID or false %}

description: >
    Yardstick TC076 config file;
    Monitor network metrics provided by the kernel in a host and calculate
    IP datagram error rate, ICMP message error rate, TCP segment error rate and
    UDP datagram error rate.

scenarios:
-
  type: Ping
  run_in_background: true
  options:
    packetsize: 200

  {% if FIXED_NET_ID and FIXED_SUBNET_ID %}
  host:
    name: "host.touchstone_tc076"
    public_ip_attr: "server1_private_ip"
    private_ip_attr: "server1_private_ip"

  target:
    name: "target.touchstone_tc076"
    public_ip_attr: "server2_private_ip"
    private_ip_attr: "server2_private_ip"
  {% else %}
  host: "host.touchstone_tc076"

  target: "target.touchstone_tc076"
  {% endif %}

-
  type: Nstat
  options:
    duration: 300

  {% if FIXED_NET_ID and FIXED_SUBNET_ID %}
  host:
    name: "target.touchstone_tc076"
    public_ip_attr: "server2_private_ip"
    private_ip_attr: "server2_private_ip"
  {% else %}
  host: "target.touchstone_tc076"
  {% endif %}

  runner:
    type: Iteration
    iterations: 1

  sla:
    IP_datagram_error_rate: 0.01
    action: monitor

context:
  name: touchstone_tc076
  user: ubuntu

  {% if FIXED_NET_ID and FIXED_SUBNET_ID %}
  heat_template: boot_with_existing_nic.yaml
  heat_parameters:
    image: {{IMAGE_NAME}}
    key_name: yardstick-key
    flavor: {{FLAVOR_NAME}}
    nic_id: {{FIXED_NET_ID}}
    subnet_id: {{FIXED_SUBNET_ID}}
    server_1_name: host.touchstone_tc076
    server_2_name: target.touchstone_tc076
  {% else %}
  image: {{IMAGE_NAME}}
  flavor: {{FLAVOR_NAME}}

  placement_groups:
    pgrp1:
      policy: "availability"

  servers:
    host:
      floating_ip: true
      placement: "pgrp1"
    target:
      floating_ip: true
      placement: "pgrp1"

  networks:
    test:
      cidr: '10.0.1.0/24'
  {% endif %}
